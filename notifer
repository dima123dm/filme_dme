"""
ÐœÐ¾Ð´ÑƒÐ»ÑŒ Ð´Ð»Ñ Ð¾Ð¿Ð¾Ð²ÐµÑ‰ÐµÐ½Ð¸Ñ Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐµÑ€Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· Telegram.

Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ `check_for_updates`, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€
RezkaClient Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð¸Ð°Ð»Ð¾Ð², Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¿Ð¸Ð·Ð¾Ð´Ð¾Ð² Ð¸
Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Telegram Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸.
"""

import os
from typing import List, Dict, Tuple, Optional

import requests

from rezka_client import RezkaClient


def _resolve_chat_id(bot_token: str) -> Optional[str]:
    """
    ÐŸÑ‹Ñ‚Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ chat_id Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°.
    Ð”Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ `getUpdates` Ð¸ Ð±ÐµÑ€Ñ‘Ñ‚ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ñ‡Ð°Ñ‚Ð° Ð¸Ð·
    Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. Ð•ÑÐ»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚, Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ñƒ Ð»ÑŽÐ±Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ chat_id Ð¸Ð»Ð¸ None.
    """
    try:
        resp = requests.get(
            f"https://api.telegram.org/bot{bot_token}/getUpdates",
            params={"limit": 1, "offset": -1},
            timeout=5,
        )
        data = resp.json()
        if not data.get("ok"):
            return None
        result = data.get("result", [])
        if not result:
            print("â„¹ï¸ Ð‘Ð¾Ñ‚ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð»ÑŽÐ±Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð±Ð¾Ñ‚Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ chat_id.")
            return None
        message = result[-1].get("message") or result[-1].get("edited_message")
        if message and message.get("chat"):
            chat_id = message["chat"].get("id")
            return str(chat_id)
    except Exception:
        pass
    return None


def check_for_updates(
    client: RezkaClient,
    watchlist: List[Dict[str, any]],
    translator_id: Optional[str] = None,
) -> None:
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÑÐµÑ€Ð¸Ð°Ð»Ñ‹ Ð² ÑÐ¿Ð¸ÑÐºÐµ watchlist Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¿Ð¸Ð·Ð¾Ð´Ð¾Ð² Ð¸
    Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Telegram. ÐšÐ°Ð¶Ð´Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² `watchlist`
    Ð´Ð¾Ð»Ð¶Ð½Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÐºÐ»ÑŽÑ‡Ð¸: `url`, `title` Ð¸ `last_episode` (ÐºÐ¾Ñ€Ñ‚ÐµÐ¶
    (season, episode)). ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸ ÑÐµÑ€Ð¸Ð¸ Ñ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡ÐµÐ¼
    `last_episode` Ñƒ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑÐµÑ€Ð¸Ð°Ð»Ð°, Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚
    ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ.

    Ð”Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° (Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    TELEGRAM_BOT_TOKEN). Ð•ÑÐ»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ TELEGRAM_CHAT_ID Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ð°,
    Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð°ÐµÑ‚ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ chat_id Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ
    Ð¼ÐµÑ‚Ð¾Ð´ `getUpdates` Telegram API. Ð”Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ
    Ð»ÑŽÐ±Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð±Ð¾Ñ‚Ñƒ.
    """
    bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not bot_token:
        print("âš ï¸ TELEGRAM_BOT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½; Ð¾Ð¿Ð¾Ð²ÐµÑ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹")
        return
    chat_id = os.getenv("TELEGRAM_CHAT_ID")
    if not chat_id:
        chat_id = _resolve_chat_id(bot_token) or None
        if not chat_id:
            # Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð±ÐµÐ· chat_id
            print("âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ chat_id; Ð¾Ð¿Ð¾Ð²ÐµÑ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹")
            return
    for item in watchlist:
        try:
            url = item.get("url")
            title = item.get("title")
            last_episode: Optional[Tuple[int, int]] = item.get("last_episode")  # type: ignore
            if not url:
                continue
            details = client.get_series_details(url)
            if not details or "seasons" not in details:
                continue
            seasons = details["seasons"]
            max_season = -1
            max_episode = -1
            for s_id, eps in seasons.items():
                if not eps:
                    continue
                s_num = int(s_id) if str(s_id).isdigit() else 0
                e_num = int(eps[-1]["episode"]) if eps[-1]["episode"].isdigit() else 0
                if s_num > max_season or (s_num == max_season and e_num > max_episode):
                    max_season = s_num
                    max_episode = e_num
            if last_episode:
                last_s, last_e = last_episode
                if max_season < last_s or (max_season == last_s and max_episode <= last_e):
                    continue
            msg = f"ðŸ“º Ð’Ñ‹ÑˆÐ»Ð° Ð½Ð¾Ð²Ð°Ñ ÑÐµÑ€Ð¸Ñ: {title} â€” ÑÐµÐ·Ð¾Ð½ {max_season}, ÑÐµÑ€Ð¸Ñ {max_episode}"
            try:
                requests.post(
                    f"https://api.telegram.org/bot{bot_token}/sendMessage",
                    data={"chat_id": chat_id, "text": msg},
                    timeout=5,
                )
                print(f"ðŸ”” ÐžÐ¿Ð¾Ð²ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: {msg}")
            except Exception:
                print("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram")
        except Exception:
            continue